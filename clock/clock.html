<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ChronoQuest ‚Äî Master Your Time</title>
  <meta name="theme-color" content="#0f2027">
  <link rel="manifest" href="manifest.json">
  <style>
    /* ---------- VARIABLES ---------- */
    :root{
      --bg:#0f2027; --bg2:#203a43; --accent:#00e5ff; --card: rgba(255,255,255,0.06);
      --surface:#0d1114; --muted:#b7c1c5; --text:#e9f8fb;
      --radius:14px;
    }
    [data-theme="light"]{
      --bg:#f3f8fb; --bg2:#e8f3f7; --accent:#0066cc; --card: rgba(0,0,0,0.05);
      --surface:#ffffff; --muted:#465560; --text:#0b1220;
    }

    /* ---------- LAYOUT ---------- */
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(120deg,var(--bg2),var(--bg));color:var(--text);}
    .app {min-height:100vh; display:flex; flex-direction:column;}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:linear-gradient(180deg, rgba(255,255,255,.03), transparent);backdrop-filter: blur(6px);}
    .brand {display:flex;gap:12px;align-items:center}
    .brand .logo {width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#22ffd8);box-shadow:0 6px 22px rgba(0,0,0,.25)}
    .brand h1{font-size:18px;margin:0}
    .brand p{margin:0;font-size:12px;color:var(--muted)}
    .header-actions {display:flex;gap:8px;align-items:center}

    main {flex:1;display:flex;position:relative;overflow:hidden}
    /* Sidebar */
    .sidebar-toggle {appearance:none;border:none;background:transparent;color:var(--text);font-size:20px;padding:8px;cursor:pointer}
    .overlay {position:fixed;inset:0;background:rgba(0,0,0,0.4);opacity:0;pointer-events:none;transition:opacity .18s}
    .sidebar {position:fixed;left:-320px;top:0;bottom:0;width:320px;background:var(--surface);box-shadow:0 20px 50px rgba(0,0,0,.5);padding:18px;transition:left .22s;z-index:60;border-top-right-radius:16px;border-bottom-right-radius:16px}
    .sidebar.open{left:0}
    .overlay.show{opacity:1;pointer-events:auto}
    .nav {display:flex;flex-direction:column;gap:10px;margin-top:8px}
    .nav button {display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;border:none;background:transparent;color:var(--text);cursor:pointer;text-align:left;font-weight:600}
    .nav button .icon {width:34px;height:34px;border-radius:8px;display:grid;place-items:center;background:rgba(255,255,255,0.03)}
    .nav button.active {background:linear-gradient(90deg, rgba(0,0,0,0.08), rgba(255,255,255,0.02))}
    .nav small{color:var(--muted);display:block;margin-top:8px;font-weight:600}

    /* Content area */
    .content {flex:1;padding:20px;display:flex;align-items:center;justify-content:center}
    .page {width:min(980px,100%);max-width:980px;display:none;animation:fade .18s ease}
    .page.active{display:block}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

    .card {background:var(--card);padding:16px;border-radius:var(--radius);box-shadow:0 10px 38px rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.03)}
    .grid {display:grid;gap:14px}
    .row {display:flex;gap:10px;align-items:center}

    /* Home */
    .home-hero{display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .hero-left{flex:1}
    .hero-title{font-size:clamp(20px,3.6vw,34px);margin:0}
    .hero-sub{color:var(--muted);margin-top:6px;font-weight:600}
    .home-actions {display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .btn {padding:10px 14px;border-radius:10px;border:none;cursor:pointer;background:rgba(255,255,255,0.06);color:var(--text);font-weight:700}
    .btn.primary{background:var(--accent);color:#001017}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}

    /* Clock page */
    .clock-face {display:grid;place-items:center;padding:26px;position:relative}
    .time {font-weight:900;font-size:clamp(44px,9vw,96px);letter-spacing:0.5px}
    .date {margin-top:8px;color:var(--muted);font-weight:700}
    .fuzzy {margin-top:6px;font-style:italic;color:var(--muted)}

    /* Alarms page */
    .alarms-list {margin-top:12px;display:grid;gap:8px;max-height:320px;overflow:auto}
    .alarm-item {display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
    .pill {padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);font-weight:700}

    /* Stopwatch / Timer */
    .big-time {font-weight:900;font-size:clamp(36px,7vw,76px);letter-spacing:0.6px}
    .controls {display:flex;gap:10px;flex-wrap:wrap}

    /* Footer */
    footer{padding:12px;text-align:center;color:var(--muted);font-size:13px}

    /* responsive */
    @media(min-width:980px){
      .sidebar{width:280px}
      .overlay{display:none}
    }
    /* small helpers */
    input, select {padding:10px;border-radius:8px;border:none;background:rgba(255,255,255,0.04);color:var(--text)}
    .small{font-size:13px;color:var(--muted)}
  </style>
</head>
<body data-theme="dark">
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden></div>
        <div>
          <h1>ChronoQuest üéÆ</h1>
          <p>Master your time ‚Äî built to grow</p>
        </div>
      </div>

      <div class="header-actions">
        <button id="hambBtn" class="sidebar-toggle" aria-label="Open menu">‚ò∞</button>
        <button id="installBtn" class="btn ghost" style="display:none">Install App</button>
      </div>
    </header>

    <main>
      <div id="overlay" class="overlay" onclick="toggleSidebar(false)"></div>

      <aside id="sidebar" class="sidebar" aria-hidden>
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <div>
            <strong style="font-size:16px">Menu</strong>
            <div class="small" style="margin-top:6px">ChronoQuest</div>
          </div>
          <button onclick="toggleSidebar(false)" style="background:transparent;border:none;color:var(--text);font-size:18px">‚úï</button>
        </div>

        <nav class="nav" aria-label="Main navigation" style="margin-top:14px">
          <button data-target="home" class="nav-btn active"><span class="icon">üè†</span><span>Home</span></button>
          <button data-target="clock" class="nav-btn"><span class="icon">‚è∞</span><span>Clock</span></button>
          <button data-target="alarms" class="nav-btn"><span class="icon">üîî</span><span>Alarms</span></button>
          <button data-target="stopwatch" class="nav-btn"><span class="icon">‚è±Ô∏è</span><span>Stopwatch</span></button>
          <button data-target="timer" class="nav-btn"><span class="icon">‚è≥</span><span>Timer</span></button>
          <button data-target="about" class="nav-btn"><span class="icon">üë®‚Äçüíª</span><span>About</span></button>
          <button data-target="donate" class="nav-btn"><span class="icon">‚ù§Ô∏è</span><span>Donate</span></button>
        </nav>

        <div style="margin-top:18px" class="small">
          <div><strong>Theme</strong></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" onclick="setTheme('dark')">Dark</button>
            <button class="btn" onclick="setTheme('light')">Light</button>
            <button class="btn" onclick="openBgPicker()">Background</button>
          </div>
        </div>

        <div style="margin-top:18px" class="small">
          <div style="margin-top:8px">Made by <strong>Omosehin Ifeyemi</strong></div>
          <div style="margin-top:6px">Built to Grow</div>
        </div>
      </aside>

      <section class="content">
        <!-- HOME -->
        <article id="home" class="page active">
          <div class="card home-hero">
            <div class="hero-left" style="min-width:260px">
              <h2 class="hero-title">ChronoQuest üéÆ</h2>
              <div class="hero-sub">Chrono = Time ‚è≥ ‚Ä¢ Quest = Adventure üó∫Ô∏è ‚Äî your journey to master time.</div>
              <div class="home-actions">
                <button class="btn primary" data-target-nav="clock">Open Clock</button>
                <button class="btn" data-target-nav="alarms">Set Alarm</button>
                <button class="btn" data-target-nav="timer">Start Focus</button>
                <button class="btn" data-target-nav="stopwatch">Stopwatch</button>
              </div>
            </div>
            <div style="min-width:240px;text-align:center">
              <div class="card" style="padding:18px">
                <div style="font-weight:800;font-size:20px">Quick Stats</div>
                <div style="display:flex;gap:10px;justify-content:center;margin-top:12px">
                  <div style="text-align:center"><div style="font-weight:900" id="statPoints">0</div><div class="small">Points</div></div>
                  <div style="text-align:center"><div style="font-weight:900" id="statSessions">0</div><div class="small">Sessions</div></div>
                  <div style="text-align:center"><div style="font-weight:900" id="statAlarms">0</div><div class="small">Alarms</div></div>
                </div>
                <div class="small" style="margin-top:12px">Tip: Use voice to add alarms (üé§) ‚Äî works best in Chrome.</div>
              </div>
            </div>
          </div>
        </article>

        <!-- CLOCK -->
        <article id="clock" class="page">
          <div class="grid">
            <div class="card clock-face">
              <div class="time" id="timeDisplay">00:00:00</div>
              <div class="date" id="dateDisplay">Monday, Jan 1, 2025</div>
              <div class="fuzzy" id="fuzzyDisplay"></div>
            </div>

            <div class="card">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                  <div style="font-weight:800">Clock Options</div>
                  <div class="small">Customize your view</div>
                </div>

                <div style="display:flex;gap:8px">
                  <button class="btn" id="toggle24">24 / 12</button>
                  <button class="btn" id="toggleFuzzy">Fuzzy</button>
                </div>
              </div>

              <hr style="opacity:.06;margin:12px 0">

              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <label class="small">Seconds <input type="checkbox" id="showSeconds" checked></label>
                <label class="small">Use Manual Time <input type="checkbox" id="useManual"></label>
              </div>

              <div style="margin-top:12px" class="small">Set manual time (only when "Use Manual Time" is ON)</div>
              <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
                <input type="number" id="manualH" placeholder="HH" min="0" max="23" style="width:88px">
                <input type="number" id="manualM" placeholder="MM" min="0" max="59" style="width:88px">
                <input type="number" id="manualS" placeholder="SS" min="0" max="59" style="width:88px">
                <button class="btn" id="applyManual">Apply</button>
              </div>
            </div>
          </div>
        </article>

        <!-- ALARMS -->
        <article id="alarms" class="page">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-weight:800">Alarms</div>
                <div class="small">Up to 10 alarms. Voice input supported.</div>
              </div>
              <div class="row">
                <button class="btn" id="voiceBtn">üé§ Voice</button>
                <div class="small pill" id="alarmCountPill">0 / 10</div>
              </div>
            </div>

            <div style="margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <input type="time" id="alarmTimeInput">
              <input type="text" id="alarmLabelInput" placeholder="Label (optional)">
              <select id="alarmRepeatInput"><option value="once">Once</option><option value="daily">Daily</option></select>
              <button class="btn primary" id="addAlarmBtn">Add Alarm</button>
            </div>

            <div class="alarms-list" id="alarmsList"></div>
          </div>
        </article>

        <!-- STOPWATCH -->
        <article id="stopwatch" class="page">
          <div class="grid">
            <div class="card" style="text-align:center">
              <div class="big-time" id="swDisplay">00:00.000</div>
              <div class="controls" style="justify-content:center;margin-top:12px">
                <button class="btn primary" id="swStartBtn">Start</button>
                <button class="btn" id="swLapBtn" disabled>Lap</button>
                <button class="btn" id="swStopBtn" disabled>Stop</button>
                <button class="btn" id="swResetBtn" disabled>Reset</button>
              </div>
              <div style="margin-top:12px" id="swLaps"></div>
            </div>

            <div class="card">
              <div style="font-weight:800">Gamification</div>
              <div class="small" style="margin-top:8px">Earn points for focused time. Stopwatch awards 1 point every 5 minutes.</div>
              <div style="margin-top:12px" class="small">Points: <strong id="pointsCount">0</strong></div>
              <div class="small" style="margin-top:8px">Sessions: <strong id="sessionsCount">0</strong></div>
            </div>
          </div>
        </article>

        <!-- TIMER -->
        <article id="timer" class="page">
          <div class="grid">
            <div class="card" style="text-align:center">
              <div class="big-time" id="timerDisplay">00:00</div>
              <div class="controls" style="justify-content:center;margin-top:12px">
                <input type="number" id="timerMinInput" placeholder="Min" style="width:100px">
                <input type="number" id="timerSecInput" placeholder="Sec" style="width:100px">
                <label class="small"><input type="checkbox" id="focusMode" checked> Focus (earn points)</label>
              </div>
              <div class="controls" style="justify-content:center;margin-top:12px">
                <button class="btn primary" id="timerStartBtn">Start</button>
                <button class="btn" id="timerPauseBtn" disabled>Pause</button>
                <button class="btn" id="timerResetBtn" disabled>Reset</button>
              </div>
            </div>

            <div class="card">
              <div style="font-weight:800">Gamification</div>
              <div class="small" style="margin-top:8px">Complete a Focus session to earn points. Points saved locally.</div>
              <div style="margin-top:12px" class="small">Current Points: <strong id="pointsCount2">0</strong></div>
              <div class="small" style="margin-top:8px">Total Sessions: <strong id="sessionsCount2">0</strong></div>
            </div>
          </div>
        </article>

        <!-- ABOUT -->
        <article id="about" class="page">
          <div class="card">
            <h3>About ChronoQuest</h3>
            <p class="small">ChronoQuest ‚Äî Chrono = Time ‚è≥ ‚Ä¢ Quest = Adventure üó∫Ô∏è. This app helps you build focus and make progress, one session at a time.</p>
            <hr style="opacity:.06">
            <h4>About the Developer</h4>
            <p><strong>Omosehin Ifeyemi</strong><br>
              I am an undergraduate Software Engineering student at <strong>McPherson University</strong>. I love thinking big and turning ideas into reality with my fingers. This is my first official project as a 100-level developer. Thank you for using ChronoQuest ‚Äî your support means a lot. More is coming! üöÄ
            </p>
            <p class="small">Contact: <a href="mailto:omosehinifeyemi@gmail.com" style="color:var(--accent)"><strong>omosehinifeyemi@gmail.com</strong></a></p>
          </div>
        </article>

        <!-- DONATE -->
        <article id="donate" class="page">
          <div class="card">
            <h3>Support the Project</h3>
            <p class="small">If you like ChronoQuest and want to support further development, you can donate below.</p>
            <div style="margin-top:12px; text-align:left">
              <p><strong>Bank:</strong> FIRST CITY MONUMENT BANK PLC (FCMB)</p>
              <p><strong>Account Number:</strong> 1798477019</p>
              <p><strong>Account Name:</strong> Ifeyemi Olumide Omosehin</p>
            </div>
            <p class="small" style="margin-top:12px">Thank you ‚Äî it helps me keep building ‚ù§Ô∏è</p>
          </div>
        </article>
      </section>
    </main>

    <footer>¬© 2025 Omosehin Ifeyemi ‚Äî Built to Grow</footer>
  </div>

  <!-- Sounds -->
  <audio id="audio-alarm" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>
  <audio id="audio-ding" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>
  <audio id="audio-reward" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>

  <script>
  /*************************************************************************
   * ChronoQuest ‚Äî Single file app script
   * Features:
   * - Overlay sidebar navigation (icons + inline labels)
   * - Clock (12/24, seconds toggle, fuzzy), manual time option
   * - Alarms: up to 10, daily/once, add by voice (Web Speech API), list, enable/disable/delete
   * - Stopwatch (laps optional) & Timer ‚Äî gamified points stored in localStorage
   * - Theme (dark/light) + background color picker
   * - Sound effects: alarm, ding, reward
   * - PWA install flow (install prompt handled)
   *************************************************************************/

  // ---------- State & Persistence ----------
  const LS_KEY = 'chronoquest:v1';
  const state = {
    is24: true,
    showSeconds: true,
    fuzzy: false,
    useManual: false,
    manualIso: null, // ISO string
    alarms: [],      // {id, timeHHMM, label, repeat, enabled}
    points: 0,
    sessions: 0,
    bg: null,
    theme: 'dark'
  };
  function loadState(){
    try{ const raw = localStorage.getItem(LS_KEY); if(raw) Object.assign(state, JSON.parse(raw)); }catch(e){}
  }
  function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); renderStats(); renderAlarms(); }
  loadState();

  // ---------- DOM shortcuts ----------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  // ---------- Navigation & sidebar ----------
  const sidebar = $('#sidebar'), overlay = $('#overlay'), hambBtn = $('#hambBtn');
  function toggleSidebar(open){
    if(open === undefined) open = !sidebar.classList.contains('open');
    sidebar.classList.toggle('open', open);
    overlay.classList.toggle('show', open);
    sidebar.setAttribute('aria-hidden', !open);
  }
  hambBtn.addEventListener('click', ()=>toggleSidebar(true));
  overlay.addEventListener('click', ()=>toggleSidebar(false));

  // nav buttons
  $$('.nav button').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const t = btn.dataset.target;
      activatePage(t);
      toggleSidebar(false);
    });
  });
  // home quick links
  $$('[data-target-nav]').forEach(b=>{
    b.addEventListener('click', ()=>activatePage(b.dataset.targetNav));
  });

  function activatePage(id){
    $$('.nav button').forEach(b=>b.classList.toggle('active', b.dataset.target===id));
    $$('.page').forEach(p=>p.classList.toggle('active', p.id===id));
    // small focus
    const el = document.getElementById(id);
    if(el) el.scrollTop = 0;
  }

  // ---------- Clock ----------
  const timeDisplay = $('#timeDisplay'), dateDisplay = $('#dateDisplay'), fuzzyDisplay = $('#fuzzyDisplay');
  function pad(n){ return String(n).padStart(2,'0'); }
  function fuzzyTime(d){
    const h = d.getHours(), m = d.getMinutes();
    const names = ["twelve","one","two","three","four","five","six","seven","eight","nine","ten","eleven"];
    const hName = names[h%12], nextName = names[(h+1)%12];
    if(m===0) return `${hName} o'clock`;
    if(m===15) return `quarter past ${hName}`;
    if(m===30) return `half past ${hName}`;
    if(m===45) return `quarter to ${nextName}`;
    if(m<30) return `${m} past ${hName}`;
    return `${60-m} to ${nextName}`;
  }

  function getNow(){
    if(state.useManual && state.manualIso){
      // manualIso is string - advance each second in render
      return new Date(state.manualIso);
    }
    return new Date();
  }

  function advanceManualByOneSecond(){
    if(state.useManual && state.manualIso){
      const d = new Date(state.manualIso);
      d.setSeconds(d.getSeconds()+1);
      state.manualIso = d.toISOString();
      saveState();
    }
  }

  function renderClock(){
    // advance manual if using
    if(state.useManual) advanceManualByOneSecond();

    const now = getNow();
    let h = now.getHours(), m = now.getMinutes(), s = now.getSeconds();
    let displayH = h, suffix = '';
    if(!state.is24){ suffix = h>=12 ? ' PM':' AM'; displayH = h%12||12; }
    const secPart = state.showSeconds ? ':'+pad(s) : '';
    timeDisplay.textContent = `${pad(displayH)}:${pad(m)}${secPart}${suffix}`;
    dateDisplay.textContent = now.toLocaleDateString(undefined, {weekday:'long', year:'numeric', month:'short', day:'numeric'});
    fuzzyDisplay.textContent = state.fuzzy ? '‚âà ' + fuzzyTime(now) : '';
    checkAlarms(now);
  }

  // one second tick
  renderClock();
  setInterval(renderClock, 1000);

  // clock controls
  $('#toggle24').addEventListener('click', ()=>{ state.is24 = !state.is24; saveState(); renderClock(); });
  $('#toggleFuzzy').addEventListener('click', ()=>{ state.fuzzy = !state.fuzzy; saveState(); renderClock(); });
  $('#showSeconds').addEventListener('change', (e)=>{ state.showSeconds = e.target.checked; saveState(); renderClock(); });
  $('#useManual').addEventListener('change', (e)=>{ state.useManual = e.target.checked; if(!state.useManual) state.manualIso = null; saveState(); });
  $('#applyManual').addEventListener('click', ()=>{
    let hh = parseInt($('#manualH').value || '0',10), mm = parseInt($('#manualM').value || '0',10), ss = parseInt($('#manualS').value || '0',10);
    hh = Math.max(0,Math.min(23,hh)); mm = Math.max(0,Math.min(59,mm)); ss = Math.max(0,Math.min(59,ss));
    const d = new Date(); d.setHours(hh,mm,ss,0); state.manualIso = d.toISOString(); state.useManual = true; $('#useManual').checked = true; saveState(); renderClock();
  });

  // ---------- Alarms ----------
  function uid(){ return crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random()).replace('.',''); }
  function renderAlarms(){
    const list = $('#alarmsList'); list.innerHTML = '';
    state.alarms.forEach((a, idx)=>{
      const el = document.createElement('div'); el.className='alarm-item';
      el.innerHTML = `<div><strong>${a.timeHHMM}</strong> &nbsp; <span class="small">${a.label||'Alarm'}</span></div>`;
      const right = document.createElement('div');
      const toggle = document.createElement('button'); toggle.className='btn'; toggle.textContent = a.enabled ? 'On':'Off';
      toggle.addEventListener('click', ()=>{ a.enabled = !a.enabled; saveState(); });
      const del = document.createElement('button'); del.className='btn danger'; del.textContent='Delete';
      del.addEventListener('click', ()=>{ state.alarms = state.alarms.filter(x=>x.id!==a.id); saveState(); renderAlarms(); });
      right.append(toggle, del);
      el.append(right);
      list.appendChild(el);
    });
    $('#alarmCountPill').textContent = `${state.alarms.length} / 10`;
    $('#statAlarms').textContent = state.alarms.length;
  }

  function addAlarm(timeHHMM, label='', repeat='once'){
    if(!timeHHMM) return alert('Pick time');
    if(state.alarms.length >= 10) return alert('Max 10 alarms reached');
    state.alarms.push({ id: uid(), timeHHMM, label, repeat, enabled:true });
    saveState(); renderAlarms();
  }

  $('#addAlarmBtn').addEventListener('click', ()=>{
    addAlarm($('#alarmTimeInput').value, $('#alarmLabelInput').value.trim(), $('#alarmRepeatInput').value);
    $('#alarmLabelInput').value=''; $('#alarmTimeInput').value='';
  });

  function hhmmFromDate(d){ return pad(d.getHours())+':'+pad(d.getMinutes()); }

  function checkAlarms(now){
    const cur = hhmmFromDate(now);
    // trigger only when seconds === 0 to avoid double triggers within minute
    if(now.getSeconds() !== 0) return;
    state.alarms.forEach(a=>{
      if(!a.enabled) return;
      if(a.timeHHMM === cur){
        // fire
        try{ $('#audio-alarm').currentTime = 0; $('#audio-alarm').play(); }catch(e){}
        navigator.vibrate?.([200,100,200]);
        alert(`‚è∞ ${a.label || 'Alarm'} ‚Äî ${a.timeHHMM}`);
        if(a.repeat === 'once'){ a.enabled = false; saveState(); renderAlarms(); }
      }
    });
  }

  renderAlarms();

  // ---------- Voice alarm (Web Speech API) ----------
  let recognition = null;
  if(window.SpeechRecognition || window.webkitSpeechRecognition){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SR();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
  }

  $('#voiceBtn').addEventListener('click', ()=>{
    if(!recognition) return alert('Voice not supported in this browser. Use Chrome for best results.');
    $('#voiceBtn').textContent = 'Listening...';
    recognition.start();
    recognition.onresult = (ev)=>{
      const phrase = ev.results[0][0].transcript.trim();
      parseVoiceAlarm(phrase);
      $('#voiceBtn').textContent = 'üé§ Voice';
    };
    recognition.onend = ()=>{ $('#voiceBtn').textContent = 'üé§ Voice'; };
    recognition.onerror = (e)=>{ $('#voiceBtn').textContent = 'üé§ Voice'; alert('Voice error'); };
  });

  function parseVoiceAlarm(phrase){
    const p = phrase.toLowerCase();
    const regexes = [
      /(\d{1,2}[:.]\d{2})\s*(am|pm)?/,           // 7:30 or 7:30 am
      /(\d{1,2})\s*(am|pm)/,                     // 7 am
      /(\d{1,2})\s+(\d{2})/                      // 19 00
    ];
    let timeFound=null, ampm=null;
    for(const re of regexes){
      const m = p.match(re);
      if(m){ timeFound = m[1]; if(m[2] && (m[2]==='am'||m[2]==='pm')) ampm = m[2]; break; }
    }
    if(!timeFound){ alert("Couldn't parse time from: " + phrase); return; }
    let hour=0, minute=0;
    if(timeFound.includes(':')||timeFound.includes('.')){
      const parts = timeFound.split(/[:.]/); hour=parseInt(parts[0],10); minute=parseInt(parts[1],10);
    } else { hour = parseInt(timeFound,10); minute = 0; }
    if(ampm){
      if(ampm==='pm' && hour<12) hour+=12;
      if(ampm==='am' && hour===12) hour = 0;
    }
    hour = Math.max(0,Math.min(23,hour)); minute = Math.max(0,Math.min(59,minute));
    const hhmm = pad(hour)+':'+pad(minute);
    // label extraction
    let label = '';
    const forMatch = p.match(/for\s+(.+)/);
    if(forMatch){ label = forMatch[1].replace(/\b(am|pm)\b/,'').trim(); }
    else {
      label = p.replace(timeFound,'').replace(/set alarm|set an alarm|alarm|at|for/gi,'').trim();
    }
    if(label.length>40) label = label.slice(0,40)+'...';
    addAlarm(hhmm, label||'Voice Alarm', 'once');
    alert(`Voice alarm set: ${hhmm} ${label?'- '+label:''}`);
  }

  // ---------- Stopwatch ----------
  let swRunning=false, swStart=0, swElapsed=0, swRAF=null;
  function fmtMs(ms){
    const total = Math.max(0, Math.floor(ms));
    const sTotal = Math.floor(total/1000);
    const m = Math.floor(sTotal/60);
    const s = sTotal%60;
    const ms3 = total%1000;
    return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${String(ms3).padStart(3,'0')}`;
  }
  function swTick(){
    if(!swRunning) return;
    const now = performance.now();
    const elapsed = swElapsed + (now - swStart);
    $('#swDisplay').textContent = fmtMs(elapsed);
    swRAF = requestAnimationFrame(swTick);
  }

  $('#swStartBtn').addEventListener('click', ()=>{
    if(swRunning) return;
    swRunning=true; swStart = performance.now(); $('#swStartBtn').disabled=true; $('#swLapBtn').disabled=false; $('#swStopBtn').disabled=false; $('#swResetBtn').disabled=true;
    swTick();
  });
  $('#swLapBtn').addEventListener('click', ()=>{
    if(!swRunning) return;
    const now = performance.now(); const elapsed = swElapsed + (now - swStart);
    const div = document.createElement('div'); div.className='small'; div.textContent = `Lap ${Date.now()%1000} ‚Äî ${fmtMs(elapsed)}`;
    $('#swLaps').prepend(div);
    playSound('ding');
  });
  $('#swStopBtn').addEventListener('click', ()=>{
    if(!swRunning) return;
    swRunning=false; cancelAnimationFrame(swRAF); swElapsed += (performance.now() - swStart);
    $('#swStartBtn').disabled=false; $('#swLapBtn').disabled=true; $('#swStopBtn').disabled=true; $('#swResetBtn').disabled=false;
  });
  $('#swResetBtn').addEventListener('click', ()=>{
    swRunning=false; cancelAnimationFrame(swRAF); swElapsed=0; swStart=0; $('#swDisplay').textContent='00:00.000'; $('#swLaps').innerHTML=''; $('#swStartBtn').disabled=false; $('#swLapBtn').disabled=true; $('#swStopBtn').disabled=true; $('#swResetBtn').disabled=true;
  });

  // award point every full 5 minutes of stopwatch (handled in tick)
  setInterval(()=>{
    if(swRunning){
      const now = performance.now();
      const elapsed = swElapsed + (now - swStart);
      const minutes = Math.floor(elapsed/60000);
      if(minutes>0 && (elapsed % 300000) < 1000){ // approximately at 5,10,15...
        awardPoint();
      }
    }
  }, 1000);

  // ---------- Timer ----------
  let timerId = null, timerRemaining = 0;
  function renderTimer(){
    const totalSec = Math.max(0, Math.ceil(timerRemaining/1000));
    const m = Math.floor(totalSec/60); const s = totalSec%60;
    $('#timerDisplay').textContent = `${pad(m)}:${pad(s)}`;
  }
  $('#timerStartBtn').addEventListener('click', ()=>{
    const min = parseInt($('#timerMinInput').value||'0',10) || 0;
    const sec = parseInt($('#timerSecInput').value||'0',10) || 0;
    let total = min*60 + sec;
    if(total<=0 && timerRemaining<=0) return alert('Set duration');
    if(timerRemaining<=0) timerRemaining = total*1000;
    if(timerId) return;
    timerId = setInterval(()=>{
      timerRemaining -= 250;
      renderTimer();
      if(timerRemaining <= 0){
        clearInterval(timerId); timerId=null; timerRemaining=0; renderTimer();
        try{ $('#audio-alarm').currentTime = 0; $('#audio-alarm').play(); }catch(e){}
        navigator.vibrate?.([200,100,200]);
        if($('#focusMode').checked) { awardPoint(true); }
        $('#timerStartBtn').disabled=false; $('#timerPauseBtn').disabled=true; $('#timerResetBtn').disabled=false;
      }
    }, 250);
    $('#timerStartBtn').disabled=true; $('#timerPauseBtn').disabled=false; $('#timerResetBtn').disabled=false;
  });
  $('#timerPauseBtn').addEventListener('click', ()=>{
    clearInterval(timerId); timerId=null; $('#timerStartBtn').disabled=false; $('#timerPauseBtn').disabled=true;
  });
  $('#timerResetBtn').addEventListener('click', ()=>{
    clearInterval(timerId); timerId=null; timerRemaining=0; renderTimer(); $('#timerStartBtn').disabled=false; $('#timerPauseBtn').disabled=true; $('#timerResetBtn').disabled=true;
  });

  // ---------- Points & gamification ----------
  function awardPoint(fromTimer=false){
    // to avoid spamming, award only once per event ‚Äî we keep it simple
    state.points = (state.points||0) + 1;
    if(fromTimer) state.sessions = (state.sessions||0) + 1;
    saveState();
    playSound('reward');
    renderStats();
  }
  function renderStats(){
    $('#statPoints').textContent = state.points || 0;
    $('#statSessions').textContent = state.sessions || 0;
    $('#pointsCount').textContent = state.points || 0;
    $('#pointsCount2').textContent = state.points || 0;
    $('#sessionsCount').textContent = state.sessions || 0;
    $('#sessionsCount2').textContent = state.sessions || 0;
  }
  renderStats();

  // ---------- Sounds ----------
  function playSound(name){
    try{
      if(name==='ding'){ $('#audio-ding').currentTime = 0; $('#audio-ding').play(); }
      if(name==='reward'){ $('#audio-reward').currentTime = 0; $('#audio-reward').play(); }
    }catch(e){}
  }

  // ---------- Background picker & theme ----------
  function openBgPicker(){
    const color = prompt('Enter background CSS color or hex (example: #e8f5e9 or linear-gradient(...))', state.bg || '');
    if(color !== null){
      state.bg = color || null;
      applyBg();
      saveState();
    }
  }
  function applyBg(){
    if(state.bg){
      document.documentElement.style.setProperty('--bg2', state.bg);
    } else {
      document.documentElement.style.removeProperty('--bg2');
    }
  }
  function setTheme(t){
    state.theme = t;
    if(t==='light') document.body.setAttribute('data-theme','light'); else document.body.setAttribute('data-theme','dark');
    saveState();
  }
  applyBg();
  setTheme(state.theme);

  // ---------- Install prompt ----------
  let deferredInstallPrompt = null;
  window.addEventListener('beforeinstallprompt', (e)=>{
    e.preventDefault();
    deferredInstallPrompt = e;
    $('#installBtn').style.display = 'inline-block';
  });
  $('#installBtn').addEventListener('click', async ()=>{
    if(!deferredInstallPrompt) return;
    deferredInstallPrompt.prompt();
    const choice = await deferredInstallPrompt.userChoice;
    deferredInstallPrompt = null;
    $('#installBtn').style.display = 'none';
  });

  // ---------- Persistence init ----------
  if(state.manualIso) $('#manualH').value = new Date(state.manualIso).getHours();
  if(state.manualIso) $('#manualM').value = new Date(state.manualIso).getMinutes();
  if(state.manualIso) $('#manualS').value = new Date(state.manualIso).getSeconds();
  renderAlarms();
  renderStats();

  // ---------- PWA Service Worker Registration ----------
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js').catch(()=>{ /* ignore */ });
  }

  // ---------- Utility: expose for debugging (optional) ----------
  window.__CQ = { state, saveState, addAlarm };

  </script>
</body>
</html>
